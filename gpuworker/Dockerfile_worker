# Dockerfile_worker - GPU Ready con OCR Support
FROM python:3.11-slim

# Installa dipendenze sistema
# - poppler-utils: pdftotext per PDF
# - libreoffice: conversione DOC/XLS/PPT vecchi
# - tesseract-ocr: OCR per documenti scansionati
# - curl: health checks
RUN apt-get update && apt-get install -y \
    poppler-utils \
    libreoffice \
    tesseract-ocr \
    tesseract-ocr-ita \
    tesseract-ocr-eng \
    curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copia e installa dipendenze Python
COPY requirements_worker.txt .
RUN pip install --no-cache-dir -r requirements_worker.txt

# Copia codice worker
COPY worker /app/worker

# Environment per RQ worker
ENV PYTHONUNBUFFERED=1

# Healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD python -c "import redis; r=redis.from_url('${REDIS_URL}'); r.ping()" || exit 1

# Default command (sovrascritto da docker-compose)
CMD ["rq", "worker", "-u", "redis://redis:6379/0", "kb_ingestion"]
