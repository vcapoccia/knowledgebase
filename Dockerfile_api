FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# dipendenze necessarie all'API (niente LibreOffice/OCR qui)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl libmagic1 && \
    rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir \
    fastapi uvicorn[standard] jinja2 \
    redis rq \
    psycopg[binary] meilisearch qdrant-client==1.9.1 \
    python-magic

# codice + statici
# lib di sistema minime già installate sopra…

# deps python (già presenti nel tuo Dockerfile)
# COPY requirements e pip install … (lascia invariato)

# copia codice backend
COPY api/main.py /app/main.py
COPY api/route_admin.py /app/route_admin.py
COPY api/route_download.py /app/route_download.py
# (se alcuni non esistono, Docker build fallisce: in tal caso commenta la riga mancante)

# copia asset web (UNA SOLA radice coerente—qui uso /web come root web)
COPY web/ /app/web/

EXPOSE 8000
CMD ["uvicorn", "main:app", "--host","0.0.0.0","--port","8000"]