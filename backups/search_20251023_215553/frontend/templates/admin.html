<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <title>Admin KB - Monitoraggio Multi-Modello</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="/static/style.css" rel="stylesheet">
  <style>
    .current-doc {
      background: #eff6ff;
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .current-doc h3 {
      margin: 0 0 0.5rem;
      color: #1e40af;
      font-size: 1.1rem;
    }
    .doc-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .step {
      background: white;
      border: 1px solid #dbeafe;
      border-radius: 8px;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.85rem;
    }
    .step.active {
      background: #3b82f6;
      color: white;
      font-weight: 600;
    }
    .step.done {
      background: #10b981;
      color: white;
    }
    .step.error {
      background: #ef4444;
      color: white;
    }
    .progress-bar {
      width: 100%;
      height: 24px;
      background: #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      transition: width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
      margin: 1rem 0;
    }
    .stat-box {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 0.75rem;
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e40af;
    }
    .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .log-entry {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    .log-entry.success {
      border-left: 4px solid #10b981;
    }
    .log-entry.error {
      border-left: 4px solid #ef4444;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    .log-file {
      font-weight: 600;
      color: #1f2937;
    }
    .log-time {
      color: #6b7280;
      font-size: 0.8rem;
    }
    .log-details {
      color: #4b5563;
      font-size: 0.85rem;
    }
    .controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge.success { background: #d1fae5; color: #065f46; }
    .badge.error { background: #fee2e2; color: #991b1b; }
    .badge.processing { background: #dbeafe; color: #1e40af; }
    
    /* Model Selector */
    .model-selector {
      background: #f8fafc;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .model-selector h4 {
      margin: 0 0 0.75rem;
      font-size: 1rem;
      color: #1e40af;
    }
    .model-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }
    .model-option {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .model-option:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    .model-option.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    .model-option input[type="radio"] {
      margin-right: 0.5rem;
    }
    .model-label {
      font-weight: 600;
      color: #1f2937;
      font-size: 1rem;
    }
    .model-desc {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    .model-tech {
      display: inline-block;
      margin-top: 0.5rem;
      padding: 0.25rem 0.5rem;
      background: #f3f4f6;
      border-radius: 4px;
      font-size: 0.75rem;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <img src="/static/ENG24-LOGO-ICON-DARK.svg" alt="Logo" class="logo">
    <h1>Admin - Ingestion Multi-Modello</h1>
  </header>

  <main class="container">
    <!-- Model Selector -->
    <section class="model-selector">
      <h4>ü§ñ Seleziona Modello Embedding</h4>
      <div class="model-options">
        <label class="model-option" id="opt-st">
          <input type="radio" name="model" value="sentence-transformer" checked>
          <div class="model-label">Sentence Transformer</div>
          <div class="model-desc">Veloce, leggero, ottimo per ricerca generale</div>
          <span class="model-tech">384-dim ‚Ä¢ Transformers</span>
        </label>
        
        <label class="model-option" id="opt-llama">
          <input type="radio" name="model" value="llama3">
          <div class="model-label">Llama 3</div>
          <div class="model-desc">Potente, preciso, richiede Ollama</div>
          <span class="model-tech">4096-dim ‚Ä¢ Ollama</span>
        </label>
        
        <label class="model-option" id="opt-mistral">
          <input type="radio" name="model" value="mistral">
          <div class="model-label">Mistral</div>
          <div class="model-desc">Bilanciato, efficiente, richiede Ollama</div>
          <span class="model-tech">4096-dim ‚Ä¢ Ollama</span>
        </label>
      </div>
    </section>

    <!-- Controlli -->
    <section class="card">
      <h3>üéÆ Controlli</h3>
      <div class="controls">
        <button id="btn-init" class="btn">üîß Inizializza Indici</button>
        <button id="btn-ingest" class="btn primary">‚ñ∂Ô∏è Avvia Ingestion</button>
        <button id="btn-pause" class="btn">‚è∏Ô∏è Pausa</button>
        <button id="btn-resume" class="btn">‚ñ∂Ô∏è Riprendi</button>
        <button id="btn-clear-failed" class="btn ghost">üóëÔ∏è Pulisci Falliti</button>
        <span id="status-msg" class="muted"></span>
      </div>
      <div id="collection-info" class="muted small" style="margin-top: 0.75rem;"></div>
    </section>

    <!-- Progress Bar -->
    <section class="card">
      <h3>üìä Progress Generale</h3>
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill" style="width: 0%">0%</div>
      </div>
      <div class="stats-grid" style="margin-top: 1rem;">
        <div class="stat-box">
          <div class="stat-value" id="stat-done">0</div>
          <div class="stat-label">Processati</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-total">0</div>
          <div class="stat-label">Totali</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-success">0</div>
          <div class="stat-label">‚úì Successo</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-failed">0</div>
          <div class="stat-label">‚úó Falliti</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-chunked">0</div>
          <div class="stat-label">üìÑ Chunked</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-meili">0</div>
          <div class="stat-label">üîç Meili</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="stat-qdrant">0</div>
          <div class="stat-label">üéØ Qdrant</div>
        </div>
      </div>
      <div id="stage-info" class="muted small" style="margin-top: 0.5rem;"></div>
    </section>

    <!-- Documento Corrente -->
    <section id="current-doc-section" class="current-doc" style="display: none;">
      <h3>üìÑ Documento in Elaborazione</h3>
      <div id="current-doc-file" class="log-file"></div>
      <div id="current-doc-path" class="muted small" style="margin: 0.25rem 0;"></div>
      
      <div class="doc-steps">
        <div class="step" id="step-reading">üìñ Lettura</div>
        <div class="step" id="step-extracting">üîç Estrazione</div>
        <div class="step" id="step-chunking">üìÑ Chunking</div>
        <div class="step" id="step-embedding">üéØ Embedding</div>
        <div class="step" id="step-qdrant">üíæ Qdrant</div>
        <div class="step" id="step-meili">üîé Meili</div>
        <div class="step" id="step-postgres">üóÑÔ∏è PostgreSQL</div>
      </div>
      
      <div id="current-doc-details" class="muted small" style="margin-top: 0.75rem;"></div>
    </section>

    <!-- Log Processing -->
    <section class="card">
      <h3>üìã Log Processamento (ultimi 50)</h3>
      <div id="processing-log" style="max-height: 400px; overflow-y: auto;">
        <div class="muted">Nessun log disponibile</div>
      </div>
    </section>

    <!-- Queue Status -->
    <section class="cards">
      <div class="card">
        <h3>üìä Queue Status</h3>
        <div class="kvs">
          <div><span>Nome</span><b id="q-name">-</b></div>
          <div><span>Jobs</span><b id="q-count">0</b></div>
          <div><span>Workers</span><b id="q-workers">0</b></div>
          <div><span>Started</span><b id="q-started">0</b></div>
          <div><span>Scheduled</span><b id="q-scheduled">0</b></div>
          <div><span>Deferred</span><b id="q-deferred">0</b></div>
          <div><span>Failed</span><b id="q-failed" class="error">0</b></div>
        </div>
      </div>

      <div class="card">
        <h3>‚ù§Ô∏è Health</h3>
        <pre id="health" style="max-height: 150px; overflow: auto;">...</pre>
      </div>
    </section>

    <!-- Documenti Falliti -->
    <section class="card">
      <h3>‚å†Documenti Falliti</h3>
      <div id="failed-list" class="failed-list">
        <div class="muted">Caricamento...</div>
      </div>
    </section>

    <!-- Link -->
    <section class="card">
      <div style="display: flex; gap: 1rem;">
        <a href="/" class="btn ghost">üè† Torna alla Ricerca</a>
        <button onclick="location.reload()" class="btn ghost">üîÑ Ricarica</button>
      </div>
    </section>
  </main>

  <footer class="container">
    <p class="muted small">Auto-refresh ogni 2 secondi</p>
  </footer>

  <script>
    const api = (path, opts={}) => fetch(path, opts).then(r => r.ok ? r.json() : Promise.reject(r));
    const $ = sel => document.querySelector(sel);

    // Model selection
    document.querySelectorAll('.model-option').forEach(opt => {
      opt.addEventListener('click', () => {
        document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
        opt.classList.add('selected');
      });
    });

    // Seleziona default
    $('#opt-st').classList.add('selected');

    // Get selected model
    function getSelectedModel() {
      const radio = document.querySelector('input[name="model"]:checked');
      return radio ? radio.value : 'sentence-transformer';
    }

    // Refresh progress e current doc
    async function refreshProgress() {
      try {
        const data = await api('/progress');
        
        // Progress bar
        const percent = data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
        $('#progress-fill').style.width = `${percent}%`;
        $('#progress-fill').textContent = `${percent}% (${data.done}/${data.total})`;
        
        // Stats
        $('#stat-done').textContent = data.done || 0;
        $('#stat-total').textContent = data.total || 0;
        $('#stat-success').textContent = data.stats?.success || 0;
        $('#stat-failed').textContent = data.stats?.failed || 0;
        $('#stat-chunked').textContent = data.stats?.chunked || 0;
        $('#stat-meili').textContent = data.stats?.meili_indexed || 0;
        $('#stat-qdrant').textContent = data.stats?.qdrant_vectorized || 0;
        
        // Stage
        $('#stage-info').textContent = `Stage: ${data.stage || 'idle'} ${data.running ? 'üü¢ Running' : '‚≠ï Stopped'}`;
        
        // Current document
        if (data.current_doc) {
          $('#current-doc-section').style.display = 'block';
          $('#current-doc-file').textContent = data.current_doc.filename || 'Unknown';
          $('#current-doc-path').textContent = data.current_doc.path || '';
          $('#current-doc-details').textContent = data.current_doc.details || '';
          
          // Update steps
          const step = data.current_doc.step || '';
          document.querySelectorAll('.step').forEach(el => el.className = 'step');
          if (step === 'reading') $('#step-reading').className = 'step active';
          if (step === 'extracting') $('#step-extracting').className = 'step active';
          if (step === 'chunking') $('#step-chunking').className = 'step active';
          if (step === 'embedding') $('#step-embedding').className = 'step active';
          if (step === 'qdrant') $('#step-qdrant').className = 'step active';
          if (step === 'meili') $('#step-meili').className = 'step active';
          if (step === 'postgres') $('#step-postgres').className = 'step active';
        } else {
          $('#current-doc-section').style.display = 'none';
        }
      } catch (e) {
        console.error('Error refreshing progress:', e);
      }
    }

    // Refresh processing log
    async function refreshProcessingLog() {
      try {
        const data = await api('/processing_log?limit=50');
        const log = $('#processing-log');
        
        if (!data.entries || data.entries.length === 0) {
          log.innerHTML = '<div class="muted">Nessun log disponibile</div>';
          return;
        }
        
        log.innerHTML = data.entries.map(entry => {
          const status = entry.status || 'unknown';
          const statusClass = status === 'success' ? 'success' : (status === 'error' ? 'error' : '');
          const badge = status === 'success' ? '<span class="badge success">‚úì OK</span>' : '<span class="badge error">‚úó Error</span>';
          
          return `
            <div class="log-entry ${statusClass}">
              <div class="log-header">
                <span class="log-file">${entry.filename || 'Unknown'}</span>
                <span class="log-time">${new Date(entry.timestamp * 1000).toLocaleTimeString()}</span>
              </div>
              <div class="log-details">
                ${badge}
                ${entry.chunks ? `üìÑ ${entry.chunks} chunks` : ''}
                ${entry.meili_indexed ? 'üîç Meili ‚úì' : ''}
                ${entry.qdrant_vectorized ? 'üéØ Qdrant ‚úì' : ''}
                ${entry.error ? `<br><span class="error">${entry.error}</span>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Error refreshing log:', e);
      }
    }

    // Refresh queue
    async function refreshQueue() {
      try {
        const s = await api('/queue');
        $('#q-name').textContent = s.queue || '-';
        $('#q-count').textContent = s.count ?? 0;
        $('#q-workers').textContent = (s.workers || []).length;
        $('#q-started').textContent = s.started_jobs ?? 0;
        $('#q-deferred').textContent = s.deferred ?? 0;
        $('#q-scheduled').textContent = s.scheduled ?? 0;
        $('#q-failed').textContent = s.failed ?? 0;
      } catch (e) {
        console.error('Error refreshing queue:', e);
      }
    }

    // Refresh health
    async function refreshHealth() {
      try {
        const h = await api('/health');
        $('#health').textContent = JSON.stringify(h, null, 2);
      } catch (e) {
        $('#health').textContent = 'Error: ' + e.message;
      }
    }

    // Refresh failed docs
    async function refreshFailed() {
      try {
        const docs = await api('/failed_docs?limit=100');
        const list = $('#failed-list');
        
        if (!docs.length) {
          list.innerHTML = '<div class="muted">‚úì Nessun documento fallito</div>';
          return;
        }
        
        list.innerHTML = docs.map(doc => `
          <div class="failed-row">
            <div class="failed-head">
              <b>${doc.filename || doc.doc_id || 'Unknown'}</b>
              <span class="muted small">${new Date((doc.ts || 0) * 1000).toLocaleString()}</span>
            </div>
            <div class="error">${doc.error || 'Unknown error'}</div>
            ${doc.path ? `<div class="small muted">üìÇ ${doc.path}</div>` : ''}
          </div>
        `).join('');
      } catch (e) {
        $('#failed-list').innerHTML = '<div class="error">Error loading failed docs</div>';
      }
    }

    // Actions
    $('#btn-init').addEventListener('click', async () => {
      $('#status-msg').textContent = '‚è≥ Inizializzazione...';
      try {
        await api('/init_indexes', { method: 'POST' });
        $('#status-msg').textContent = '‚úì Indici inizializzati';
      } catch (e) {
        $('#status-msg').textContent = '‚úó Errore: ' + e.message;
      }
      refreshHealth();
      refreshQueue();
    });

    $('#btn-ingest').addEventListener('click', async () => {
      const model = getSelectedModel();
      $('#status-msg').textContent = `‚è≥ Avvio ingestion con ${model}...`;
      
      try {
        const r = await api(`/ingestion/start?model=${model}`, { method: 'POST' });
        $('#status-msg').textContent = `‚úì Job avviato: ${r.job_id || ''} (${model})`;
        
        // Update collection info
        const collectionMap = {
          'sentence-transformer': 'kb_st_docs',
          'llama3': 'kb_llama3_docs',
          'mistral': 'kb_mistral_docs'
        };
        $('#collection-info').textContent = `Collection: ${collectionMap[model]} (${model})`;
      } catch (e) {
        $('#status-msg').textContent = '‚úó Errore: ' + e.message;
      }
      refreshQueue();
    });

    $('#btn-pause').addEventListener('click', async () => {
      try {
        await api('/ingestion/pause', { method: 'POST' });
        $('#status-msg').textContent = '‚è∏Ô∏è Pausa attivata';
      } catch (e) {
        $('#status-msg').textContent = '‚úó Errore: ' + e.message;
      }
    });

    $('#btn-resume').addEventListener('click', async () => {
      try {
        await api('/ingestion/resume', { method: 'POST' });
        $('#status-msg').textContent = '‚ñ∂Ô∏è Ripresa attivata';
      } catch (e) {
        $('#status-msg').textContent = '‚úó Errore: ' + e.message;
      }
    });

    $('#btn-clear-failed').addEventListener('click', async () => {
      if (!confirm('Vuoi davvero pulire la lista dei documenti falliti?')) return;
      try {
        await api('/failed_docs', { method: 'DELETE' });
        $('#status-msg').textContent = '‚úì Lista pulita';
        refreshFailed();
      } catch (e) {
        $('#status-msg').textContent = '‚úó Errore: ' + e.message;
      }
    });

    // Initial load
    refreshProgress();
    refreshProcessingLog();
    refreshQueue();
    refreshHealth();
    refreshFailed();

    // Auto-refresh
    setInterval(() => {
      refreshProgress();
      refreshProcessingLog();
      refreshQueue();
      refreshFailed();
    }, 2000);
  </script>
</body>
</html>
